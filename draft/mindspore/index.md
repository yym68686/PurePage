train_net.py main()

评估部分

- [ ] model = DefaultTrainer.build_model()
- [ ] Checkpointer().load()
- [ ] res = DefaultTrainer.test()

训练部分

- [ ] trainer = DefaultTrainer() -> fastreid.engine.defaults.DefaultTrainer
  - [ ] data_loader, single_data_loader = self.build_train_loader()
    - [ ] return build_reid_train_loader()
      - [ ] comm.get_world_size()
      - [ ] batch_sampler = torch.utils.data.sampler.BatchSampler()
      - [ ] train_loader = DataLoaderX()
      - [ ] comm.get_local_rank()
  - [ ] cfg = self.auto_scale_hyperparams()
    - [ ] comm.is_main_process()
      - [ ] return get_rank()
  - [ ] model = self.build_model()
    - [ ] model = build_model()
      - [ ] model = META_ARCH_REGISTRY.get()
      - [ ] model.to(torch.device())
  - [ ] optimizer, param_wrapper = self.build_optimizer()
    - [ ] return build_optimizer()
      - [ ] params = get_default_optimizer_params()
      - [ ] params = ContiguousParams()
      - [ ] return maybe_add_freeze_layer()
      - [ ] maybe_add_gradient_clipping()
  - [ ] model = torch.nn.DataParallel()
  - [ ] self.scheduler = self.build_lr_scheduler()
    - [ ] return build_lr_scheduler()
      - [ ] lr_scheduler.WarmupLR()
  - [ ] self._trainer = (AMPTrainer if cfg.SOLVER.AMP.ENABLED else SimpleTrainer)()
    - [ ] AMPTrainer
      - [ ] super().__init__()
      - [ ] from torch.cuda.amp import GradScaler
      - [ ] grad_scaler = GradScaler()
    - [ ] SimpleTrainer
      - [ ] super().__init__()
      - [ ] model.train()
  - [ ] self.checkpointer = Checkpointer()
  - [ ] comm.is_main_process()
    - [ ] return get_rank()
  - [ ] self.register_hooks()
  - [ ] self.build_hooks()
    - [ ] hooks.IterationTimer()
      - [ ] self._step_timer = Timer()
    - [ ] hooks.LRScheduler()
    - [ ] hooks.get_bn_modules()
      - [ ] BN_MODULE_TYPES
    - [ ] hooks.PreciseBN()
      - [ ] get_bn_modules()
    - [ ] self.build_train_loader()
      - [ ] return build_reid_train_loader()
    - [ ] hooks.LayerFreeze()
- [ ] trainer.resume_or_load() -> fastreid.engine.defaults.DefaultTrainer.resume_or_load
  - [ ] checkpoint = self.checkpointer.resume_or_load()
    - [ ] self.has_checkpoint()
    - [ ] self.get_checkpoint_file()
    - [ ] self.load()
  - [ ] self.checkpointer.has_checkpoint()
    - [ ] return PathManager.exists()
- [ ] trainer.train() -> fastreid.engine.train_loop.TrainerBase.train
  - [ ] super().train()
    - [ ] EventStorage()
    - [ ] self.before_train()
    - [ ] self.before_epoch()
    - [ ] self.before_step()
    - [ ] self.run_step()
    - [ ] self.after_step()
    - [ ] self.after_epoch()
    - [ ] self.after_train()
  - [ ] comm.is_main_process()
    - [ ] return get_rank()
  - [ ] return self._last_eval_results
    - [ ] self._last_eval_results = self.test()